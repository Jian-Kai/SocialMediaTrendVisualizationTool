<!DOCTYPE html>
<html>

<body>

</body>
<!--lib-->
<script src="http://d3js.org/d3.v4.min.js"></script>
<script src="http://numericjs.com/numeric/lib/numeric-1.2.6.min.js"></script>
<link rel="stylesheet" href="../src/style.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="http://danml.com/js/download2.js"></script>

<!--src-->
<script src="../src/overview.js"></script>
<script src="../src/mds.js"></script>
<script src="../src/tsne.js"></script>
<script>
    let posts = [],
        normalize_temp = [];

    let Ans = [];

    function main(data) {
        data.sort(function (a, b) {
            return new Date(a.created_time) - new Date(b.created_time);
        });

        for (var i = 0; i < data.length; i++) {
            posts[i] = {
                "post": i,
                "id": data[i].id,
                "from": data[i].from,
                "type": data[i].type,
                "created_time": new Date(data[i].created_time),
                "like": data[i].reactions.like + data[i].reactions.love + data[i].reactions.haha + data[i].reactions
                    .wow + data[i].reactions.sad + data[i].reactions.angry,
                "reactions": data[i].reactions,
                "share": data[i].shares,
                "comment": data[i].comments.summary,
                "message": data[i].message,
                "nor_like": 0,
                "nor_share": 0,
                "nor_comment": 0,
                "message_length": 0,
                "word": data[i].word,
                "comment_context": data[i].comments.context,
                "total_reply": 0,
                "reactions_nor": {
                    "love": 0,
                    "haha": 0,
                    "wow": 0,
                    "sad": 0,
                    "angry": 0
                },
                "log_attribute": {
                    "like": Math.log(data[i].likes + 1),
                    "comment": Math.log(data[i].comments.summary + 1),
                    "share": Math.log(data[i].shares + 1)
                }
            }
            for (var j = 0; j < data[i].comments.context.length; j++) {
                if (data[i].comments.context[j].comment_count)
                    posts[i].total_reply += data[i].comments.context[j].comment_count;
            }
            //posts[i].total_reply = Math.log(posts[i].total_reply + 1);
            posts[i].total_reply = (posts[i].total_reply);

            normalize_temp.push({
                "like": posts[i].like,
                "share": posts[i].share,
                "comment": posts[i].comment,
                "totalreply": posts[i].total_reply,
                "message": posts[i].message.length,
                "love": posts[i].reactions.love,
                "haha": posts[i].reactions.haha,
                "wow": posts[i].reactions.wow,
                "sad": posts[i].reactions.sad,
                "angry": posts[i].reactions.angry
            })
        }

        posts = overview.normalize(posts); //normalize

        console.log(posts);

        var distance_matrix = [];
        var time_metrix = [];

        for (var i = 0; i < posts.length; i++) {
            distance_matrix[i] = [];
            time_metrix[i] = [];
            for (var j = 0; j < posts.length; j++) {
                distance_matrix[i][j] = 0;
                time_metrix[i][j] = 0;
                //texst_metrix[i][j] = 0;
            }
        }

        for (var i = 0; i < posts.length; i++) {
            for (var j = i + 1; j < posts.length; j++) {


                distance_matrix[i][j] += Math.pow((posts[i].nor_comment - posts[j].nor_comment), 2);
                distance_matrix[i][j] += Math.pow((posts[i].nor_like - posts[j].nor_like), 2);
                distance_matrix[i][j] += Math.pow((posts[i].nor_share - posts[j].nor_share), 2);
                distance_matrix[i][j] += Math.pow((posts[i].message_length - posts[j].message_length), 2);
                distance_matrix[i][j] += Math.pow((posts[i].total_reply - posts[j].total_reply), 2);

                time_metrix[i][j] += Math.pow((posts[i].reactions_nor.love - posts[j].reactions_nor.love), 2);
                time_metrix[i][j] += Math.pow((posts[i].reactions_nor.haha - posts[j].reactions_nor.haha), 2);
                time_metrix[i][j] += Math.pow((posts[i].reactions_nor.wow - posts[j].reactions_nor.wow), 2);
                time_metrix[i][j] += Math.pow((posts[i].reactions_nor.sad - posts[j].reactions_nor.sad), 2);
                time_metrix[i][j] += Math.pow((posts[i].reactions_nor.angry - posts[j].reactions_nor.angry), 2);



                distance_matrix[i][j] = Math.sqrt(distance_matrix[i][j]);
                distance_matrix[j][i] = distance_matrix[i][j];

                time_metrix[i][j] = Math.sqrt(time_metrix[i][j]);
                time_metrix[j][i] = time_metrix[i][j];


            }
        }

        console.log(distance_matrix.length);

        var Y = mds.classic(distance_matrix);

        console.log(Y.length);

        tSNE(Y, time_metrix)

    }

    async function tSNE(MDS_pos, time_metrix) {
        for (var j = 500; j <= 2000; j += 500)
            for (var i = 10; i <= 30; i += 5) {
                var temp = await parameter(i, j, MDS_pos, time_metrix);

                download(new Blob([JSON.stringify({
                    "perplexity": i,
                    "time": 500,
                    "pos": temp
                })]), "pos.json", "text/plain");
                /*
                await (Ans.push({
                    "perplexity": i,
                    "time": 500,
                    "pos": temp
                }))

                console.log(Ans)
                */
            }
        //console.log(Ans)
        download(new Blob([JSON.stringify(Ans)]), "pos.json", "text/plain");

    }

    async function parameter(perplexity, time, MDS_pos, time_metrix) {
        return new Promise((resolve, reject) => {
            var opt = {}
            opt.epsilon = 10; // epsilon is learning rate (10 = default)
            opt.perplexity = perplexity; // roughly how many neighbors each point influences (30 = default)
            opt.dim = 2; // dimensionality of the embedding (2 = default)

            var tsne = new tsnejs.tSNE(opt); // create a tSNE instance

            tsne.initDataDist(time_metrix, MDS_pos);

            console.log("/////////////////start/////////////");
            for (var k = 0; k < time; k++) {
                //console.log(k);
                tsne.step(); // every time you call this, solution gets better
            }

            var Tpos = tsne.getSolution(); // Y is an array of 2-D points that you can plot


            resolve(Tpos);

        })

    }


    //===============get data=================================
    function retrievePostid() {
        function reqListener() {
            var raw_data = JSON.parse(this.responseText);
            //console.log(raw_data);
            /*
            for(var i = 0; i < 20; i++){
                raw_data.push(raw_data[i]);
            }
            */
            main(raw_data);
            //data = raw_data;
            //temp = [];
        }
        var url = window.location.href.split("?")[1];
        console.log(url);
        //console.log(since);
        var oReq = new XMLHttpRequest();
        oReq.onload = reqListener;

        var qurl = "compare" + "?action=first&fanpage=" + url;
        console.log(qurl);
        oReq.open("get", qurl, true);
        oReq.send();
    }
    window.onload = retrievePostid;
</script>

</html>