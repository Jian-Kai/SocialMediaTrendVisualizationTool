<html>

<head>
    <!-- libs -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js'></script>
    <script src="http://numericjs.com/numeric/lib/numeric-1.2.6.js"></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js'></script>
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css'>
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js'></script>

    <script src="http://ajax.googleapis.com/ajax/libs/prototype/1.7/prototype.js"></script>
    <script src="http://calendarview.org/releases/1.2/javascripts/calendarview.js"></script>
    <link href="http://calendarview.org/releases/1.2/stylesheets/calendarview.css" rel="stylesheet" type="text/css" />


    <script src="../src/mds.js"></script>
    <script src="../src/graph.js"></script>
    <script src="../src/sylvester.src.js"></script>
    <script src="../src/dissimilar.js"></script>

    <style type="text/css">
        body {
            font-family: Trebuchet MS;
            background-color: gray;
        }
        
        div.calendar {
            max-width: 240px;
            margin-left: auto;
            margin-right: auto;
        }
        
        div.calendar table {
            1 width: 100%;
            margin-top: 150px;
        }
        
        #tooltip {
            position: absolute;
            padding: 10px;
            background-color: white;
            -webkit-border-radius: 10px;
            -moz-border-radius: 10px;
            border-radius: 10px;
            -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            overflow-x: hidden;
        }
        
        #tooltip.hidden {
            display: none;
        }
        
        #tooltip p {
            margin: 0;
            font-family: sans-serif;
            font-size: 16px;
            line-height: 20px;
        }
        
        .point.scanned {
            fill: orange;
            fill-opacity: 1;
            stroke: brown;
        }
        
        .point.selected {
            fill: red;
            fill-opacity: 1;
        }
        
        .ellipsis {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .ellipsis:hover {
            white-space: inherit;
            overflow: visible;
            text-overflow: inherit;
        }
    </style>
</head>

<body>
    <div id="fb-root"></div>
    <script src='../server/fbOauthLogin.js'></script>
    <div class='container'>
        <div class='col-lg-12 text-center'>
            <button class="btn btn-link btn-inverse offset3" id="user-info" class="muted"></button>
            <button type="button" class="btn btn-inverse" id="fb-auth"></button>
            <h2></h2>
            <input class='input-medium' id='postid_input' placeholder='Facebook URL / Facebook Post Id'></input>
            <input class='input-small' id="sinceDateField" type="text" placeholder="yyyy-mm-dd">
            <input class='input-small' id="untilDateField" type="text" placeholder="yyyy-mm-dd">

            <button class='btn btn-primary' id='submit_btn' onclick="retrievePostid('first')">Visualize data!</button>
            <button class='btn btn-primary' id='DB_btn' onclick="retrievePostid('sec')">Visualize DB data!</button>
        </div>
    </div>
    <hr>
    <div>
        &nbsp;&nbsp;&nbsp;
        <label class="checkbox-inline">
            <input type="checkbox" id="Like"  checked>Like
        </label>
        <label class="checkbox-inline">
            <input type="checkbox" id="Share"  checked>Share
        </label>
        <label class="checkbox-inline">
            <input type="checkbox" id="Comment"  checked>Comment
        </label>
        <label class="checkbox-inline">
            <input type="checkbox" id="Emotion"  checked>Emotion
        </label>
        <hr>
        <div id="nodelinkSvg"></div>
        <div id="linechartSvg"></div>
        <div id="tooltip" class="hidden">
            <p><strong>PostID : </strong><span id="postid"></span>&nbsp;&nbsp;&nbsp;<strong>Link : </strong>
                <a href=" " id="link"></a>
            </p>
            <br>
            <p><strong>Type : </strong><span id="type"></span>&nbsp;&nbsp;&nbsp;<strong>Create Time : </strong><span id="created_time"></span></p>
            <br>
            <p><strong>Message : </strong>
                <br><span id="message" class="ellipsis"></span></p>
            <br>
            <p><strong>Likes : </strong><span id="likes"></span>&nbsp;people like this post</p>
            <br>
            <p><strong>Emtions : </strong><span id="emotions"></span>&nbsp;emtion score</p>
            <br>
            <p><strong>Comments : </strong><span id="comments"></span>&nbsp;people comment this post</p>
            <br>
            <p><strong>Shares : </strong><span id="shares"></span>&nbsp;people share this post</p>
            <br>
        </div>
        <div id="bartip" class="hidden">
            <p><strong>Like Count : </strong><span id="Like_Count"></span>
            </p>
        </div>
    </div>


    <script>
        var data;

        function setupCalendars() {
            // Popup Calendar
            Calendar.setup({
                dateField: 'sinceDateField',
                triggerElement: 'sinceDateField'
            })
            Calendar.setup({
                dateField: 'untilDateField',
                triggerElement: 'untilDateField'
            })
        }
        Event.observe(window, 'load', function () {
            setupCalendars()
        });

        function retrievePostid(value) {
            function reqListener() {
                var raw_data = JSON.parse(this.responseText);
                //console.log(raw_data);
                console.log(raw_data);
                data = raw_data;
                context();
            }
            var postid = document.getElementById("postid_input").value;
            var since = document.getElementById("sinceDateField").value.split("-");
            var until = document.getElementById("untilDateField").value.split("-");
            //console.log(since);
            var oReq = new XMLHttpRequest();
            oReq.onload = reqListener;
            if (value == "first") {
                var qurl = "crawler" + "?action=first&postid=" + postid + "&since=" + since + "&until=" + until +
                    "&token=" + ACCESS_TOKEN;
            } else {
                var qurl = "crawler" + "?action=sec";
            }
            console.log(qurl);
            oReq.open("get", qurl, true);
            oReq.send();
        }

        function context() {

            console.log(data);
            var window_height = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
            var window_width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;

            var cheak_like = document.getElementById("Like").checked;
            var cheak_share = document.getElementById("Share").checked;
            var cheak_comment = document.getElementById("Comment").checked;
            var cheak_emotion = document.getElementById("Emotion").checked;

            var height = window_height * (6 / 10),
                width = window_width / 2;

            document.getElementById("tooltip").style.width = (width - 100) + "px";

            var likes = get_likes();
            var emotion = get_emotion();
            var comments = get_comment();
            var shares = get_shares();

            var minlike = d3.min(likes);
            var maxlike = d3.max(likes);
            var mincomment = d3.min(comments);
            var maxcomment = d3.max(comments);
            var minshare = d3.min(shares);
            var maxshare = d3.max(shares);

            console.log(maxlike);
            console.log(minlike);

            console.log(maxshare);
            console.log(minshare);

            var like_scale = d3.scale.linear()
                .domain([minlike, maxlike])
                .range([0, 100]);
            var share_scale = d3.scale.linear()
                .domain([mincomment, maxshare])
                .range([0, 100]);

            var comment_scale = d3.scale.linear()
                .domain([minshare, maxcomment])
                .range([0, 100]);

            //================================================distance matrix=============================================================
            var posts = [];

            for (var i = 0; i < data.length; i++) {
                posts[i] = {
                    "post": i,
                    "id": data[i].id,
                    "type": data[i].type,
                    "created_time": new Date(data[i].created_time),
                    "like": data[i].likes + 1,
                    "emotion": emotion[i] + 1,
                    "share": data[i].shares + 1,
                    "comment": data[i].comments.summary + 1,
                    "message": data[i].message,
                    "likerank": null,
                    "sharerank": null
                };
            }

            posts.sort(function (a, b) {
                return new Date(a.created_time) - new Date(b.created_time);
            });

            var standard = {
                "maxlike": maxlike,
                "minlike": minlike,
                "maxshare": maxshare,
                "minshare": minshare
            };

            posts = dissimilar.rank(posts, standard);
            console.log(posts);
            //===================mean and standard deviation=========================================

            var like_mean = 0,
                share_mean = 0,
                comment_mean = 0,
                emotion_mean = 0;
            var like_SD = 0,
                share_SD = 0,
                comment_SD = 0,
                emotion_SD = 0;

            for (var i = 0; i < data.length; i++) {

                like_mean += posts[i].like;
                share_mean += posts[i].share;
                comment_mean += posts[i].comment;
                emotion_mean += posts[i].emotion;

            }

            like_mean = like_mean / data.length;
            share_mean = share_mean / data.length;
            comment_mean = comment_mean / data.length;
            emotion_mean = emotion_mean / data.length;

            for (var i = 0; i < data.length; i++) {

                like_SD += Math.pow(posts[i].like - like_mean, 2);
                share_SD += Math.pow(posts[i].share - share_mean, 2);
                comment_SD += Math.pow(posts[i].comment - comment_mean, 2);
                emotion_SD += Math.pow(posts[i].emotion - emotion_mean, 2);

            }

            like_SD = Math.sqrt(like_SD / data.length);
            share_SD = Math.sqrt(share_SD / data.length);
            comment_SD = Math.sqrt(comment_SD / data.length);
            emotion_SD = Math.sqrt(emotion_SD / data.length);

            console.log("SD");
            console.log(like_SD);
            console.log(share_SD);
            console.log(comment_SD);
            console.log(emotion_SD);

            console.log("mean");
            console.log(like_mean);
            console.log(share_mean);
            console.log(comment_mean);
            console.log(emotion_mean);

            //======================================================================================

            var dis_distance = dissimilar.distance(posts, cheak_share, cheak_emotion, cheak_like, cheak_comment);

            var Positions = numeric.transpose(mds.classic(dis_distance));

            console.log(Positions);
            //console.log(labels);

            var w = Math.min(720, document.documentElement.clientWidth - 20),
                h = w / 2;

            drawD3ScatterPlot(d3.select("#nodelinkSvg"),
                Positions[0],
                Positions[1],
                posts, {
                    w: Math.min(720, document.documentElement.clientWidth - 20),
                    h: w / 2,
                    padding: 37,
                    reverseX: true,
                    reverseY: true,
                });

            drawlinechart(d3.select("#linechartSvg"), posts, {
                    w: Math.min(720, document.documentElement.clientWidth - 20),
                    h: w / 2,
                    padding: 37,
                    reverseX: true,
                    reverseY: true,
                },
                standard);
        }


        function get_likes() {
            var temp = [];
            for (var i = 0; i < data.length; i++) {
                temp.push(data[i].likes);
            }
            return temp;
        };

        function get_shares() {
            var temp = [];
            for (var i = 0; i < data.length; i++) {
                temp.push(data[i].shares);
            }
            return temp;
        };

        function get_emotion() {
            var temp = [],
                linear = [];

            for (var i = 0; i < data.length; i++) {
                var score = data[i].reactions.love + data[i].reactions.haha * 0.5 + data[i].reactions.wow * 0.5 - data[
                    i].reactions.angry * 2 - data[i].reactions.sad;
                score = score / 10;
                temp.push(score);
            }

            var Sscale = d3.scale.linear()
                .domain([d3.min(temp) - 50, d3.max(temp) + 50])
                .range([1, 100]);
            for (var i = 0; i < temp.length; i++) {
                linear[i] = Sscale(temp[i]);
            }
            return linear;
        };

        function get_comment() {
            var temp = [];
            for (var i = 0; i < data.length; i++) {
                temp.push(data[i].comments.summary);
            }
            return temp;
        }

        function formatFloat(num, pos) {
            var size = Math.pow(10, pos);
            return Math.round(num * size) / size;
        }
    </script>

</body>

</html>