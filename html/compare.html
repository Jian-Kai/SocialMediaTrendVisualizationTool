<!DOCTYPE html>
<meta charset="utf-8">
<html>
<style>
    body {
        background-color: lightblue;
    }
</style>

<!--lib-->
<script src="http://d3js.org/d3.v4.min.js"></script>
<script src="http://numericjs.com/numeric/lib/numeric-1.2.6.min.js"></script>



<!--srcs-->
<script src="../src/K-means.js"></script>
<script src="../src/mds.js"></script>
<script src="../src/sylvester.src.js"></script>
<script src="../src/dissimilar.js"></script>
<script src="../src/multiplot.js"></script>

<body>
    <div id="main"></div>
    <script>
        var posts = [];
        var xScale, yScale, color;
        var select_rect = [];
        var means = [];
        var assignments = [];

        function main(data) {

            for (var i = 0; i < data.length; i++) {
                posts[i] = {
                    "post": i,
                    "id": data[i].id,
                    "from": data[i].from,
                    "type": data[i].type,
                    "created_time": new Date(data[i].created_time),
                    "like": data[i].likes,
                    "reactions": data[i].reactions,
                    "share": data[i].shares,
                    "comment": data[i].comments.summary,
                    "message": data[i].message,
                    "log_like": Math.log(data[i].likes + 1) / Math.log(10),
                    "log_share": Math.log(data[i].shares + 1) / Math.log(10),
                    "log_comment": Math.log(data[i].comments.summary + 1),
                    "message_length": data[i].message_length,
                    "word": data[i].word
                };
            }

            posts.sort(function (a, b) {
                return new Date(a.created_time) - new Date(b.created_time);
            });

            console.log(posts);

            var dis_distance = dissimilar.distance(posts, null);
            var P = mds.classic(dis_distance);
            var Positions = numeric.transpose(P);

            //console.log(P[0]);

            //======================k-means=========================================

            var dataExtremes = K_means.getDataExtremes(P);
            var dataRange = K_means.getDataRanges(dataExtremes);
            means = K_means.initMeans(6, dataExtremes, dataRange);
            K_means.makeAssignments(P);
            K_means.run(P);

            console.log(means);
            console.log(assignments);
            
            //======================================================================
            var classficy = [];
            for (var j = 0; j < 12; j++) {
                var temp = [];
                for (var i = 0; i < posts.length; i++) {
                    var month = posts[i].created_time.getMonth();
                    if (month == j) {
                        temp.push({
                            "post": posts[i],
                            "index": i
                        });
                    }
                }
                classficy[j] = temp;
            }

            //console.log(classficy);

            var window_height = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
            var window_width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;


            //================y軸 以原點到個貼文之間的距離================================
            var origin = [];
            for (var i = 0; i < posts.length; i++) {
                var dis = Math.pow(Positions[0][i], 2) + Math.pow(Positions[1][i], 2);
                dis = Math.sqrt(dis);

                origin.push(Positions[0][i]);
            }
            //========================================================================

            var graph = d3.select("#main");

            var svg = graph.append("svg")
                .attr("x", 0)
                .attr("y", 0)
                .attr("height", 250)
                .attr("width", 250)
                .attr("id", "svg1");

            var h = 250,
                w = 250;

            var rect = svg
                .append("rect")
                .attr("x", 0)
                .attr("y", 0)
                .attr("height", h)
                .attr("width", w)
                .attr("fill", "white");

            xScale = d3.scaleLinear()
                .range([25, 225])
                .domain([Math.min.apply(null, Positions[0]), Math.max.apply(null, Positions[0])]);
            yScale = d3.scaleLinear()
                .range([25, 225])
                .domain([Math.max.apply(null, Positions[1]), Math.min.apply(null, Positions[1])]);
            color = d3.scaleLinear()
                .domain([0, classficy.length])
                .interpolate(d3.interpolateHcl)
                .range([d3.rgb("#007AFF"), d3.rgb('#FFF500')])


            var circle = svg.selectAll("circle")
                .data(posts)
                .enter()
                .append("circle")
                .attr("id", function (d, i) {
                    return i;
                })
                .attr("cx", function (d, i) {
                    return xScale(Positions[0][i]);
                })
                .attr("cy", function (d, i) {
                    return yScale(Positions[1][i]);
                })
                .attr("r", 2.5)
                .attr("fill", function (d, i) {
                    return color(assignments[i]);
                });

            d3.select("#main")
                .append("svg")
                .style('position', 'absolute')
                .style("left", 300 + "px")
                .attr("width", window_width - 300)
                .attr("height", window_height / 2)
                .attr("id", "svg2");

            xScale
                .domain([Math.min.apply(null, Positions[0]), Math.max.apply(null, Positions[0])]);
            yScale
                .domain([Math.max.apply(null, Positions[1]), Math.min.apply(null, Positions[1])]);

            var pos = multiplot.multi(10, classficy, window_width - 300, window_height / 2);

            multiplot.plot(pos, classficy, Positions);

            d3.select("#main")
                .append("svg")
                .style('position', 'absolute')
                .style("top", window_height / 2 + "px")
                .style("left", 0 + "px")
                .attr("width", window_width)
                .attr("height", window_height / 2)
                .attr("id", "svg3");

        }

        //===============get data=================================
        function retrievePostid() {
            function reqListener() {
                var raw_data = JSON.parse(this.responseText);
                //console.log(raw_data);

                main(raw_data);
                //data = raw_data;
                //temp = [];
            }
            //console.log(since);
            var oReq = new XMLHttpRequest();
            oReq.onload = reqListener;

            var qurl = "compare" + "?action=start";
            console.log(qurl);
            oReq.open("get", qurl, true);
            oReq.send();
        }
        window.onload = retrievePostid;
    </script>
</body>

</html>