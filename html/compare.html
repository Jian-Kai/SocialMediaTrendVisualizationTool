<!DOCTYPE html>
<meta charset="utf-8">
<html>
<style>
    body {
        background-color: lightblue;
    }
</style>

<!--lib-->
<script src="http://d3js.org/d3.v4.min.js"></script>
<script src="http://numericjs.com/numeric/lib/numeric-1.2.6.min.js"></script>



<!--srcs-->
<script src="../src/K-means.js"></script>
<script src="../src/mds.js"></script>
<script src="../src/sylvester.src.js"></script>
<script src="../src/dissimilar.js"></script>
<script src="../src/multiplot.js"></script>
<script src="../src/tsne.js"></script>

<body>
    <div id="main"></div>
    <script>
        var posts = [];
        var xScale, yScale, color;
        var select_rect = [], select = [];
        var means = [];
        var assignments = [];
        var dataExtremes;
        var dataRange;

        function main(data) {
            //console.log(data);
            for (var i = 0; i < data.length; i++) {
                posts[i] = {
                    "post": i,
                    "id": data[i].id,
                    "from": data[i].from,
                    "type": data[i].type,
                    "created_time": new Date(data[i].created_time),
                    "like": data[i].reactions.like + data[i].reactions.love + data[i].reactions.haha + data[i].reactions
                        .wow + data[i].reactions.sad + data[i].reactions.angry,
                    "reactions": data[i].reactions,
                    "share": data[i].shares,
                    "comment": data[i].comments.summary,
                    "message": data[i].message,
                    "log_like": Math.log(data[i].likes + 1) / Math.log(10),
                    "log_share": Math.log(data[i].shares + 1) / Math.log(10),
                    "log_comment": Math.log(data[i].comments.summary + 1),
                    "message_length": Math.log(data[i].message_length + 1),
                    "word": data[i].word
                };
            }

            posts.sort(function (a, b) {
                return new Date(a.created_time) - new Date(b.created_time);
            });

            console.log(posts);

            var dis_distance = dissimilar.distance(posts, null);
            console.log(dis_distance);
            //var P = mds.classic(dis_distance);
            //var Positions = numeric.transpose(P);
            
            //==============================normalize====================================================
/*
            var max = 0;
            for (var i = 0; i < dis_distance.length; i++) {
                if (Math.max.apply(null, dis_distance[i]) >= max) {
                    max = Math.max.apply(null, dis_distance[i]);
                }
            }

            console.log("Max dis: " + max);

            for (var i = 0; i < dis_distance.length; i++) {
                for (var j = 0; j < dis_distance.length; j++) {
                    dis_distance[i][j] = 1 - (dis_distance[i][j] / max);
                }
            }
*/
            //==============================normalize====================================================

            //==========================t-sne==========================================================
            var opt = {}
            opt.epsilon = 10; // epsilon is learning rate (10 = default)
            opt.perplexity = 15; // roughly how many neighbors each point influences (30 = default)
            opt.dim = 2; // dimensionality of the embedding (2 = default)

            var tsne = new tsnejs.tSNE(opt); // create a tSNE instance

            tsne.initDataDist(dis_distance);


            for (var k = 0; k < 1000; k++) {
                tsne.step(); // every time you call this, solution gets better
            }

            var P = tsne.getSolution(); // Y is an array of 2-D points that you can plot
            //==========================t-sne==========================================================

            console.log(numeric.transpose(P));

            //var P = mds.classic(dis_distance);
            var Positions = numeric.transpose(P);

            //======================k-means=========================================

            dataExtremes = K_means.getDataExtremes(P);
            dataRange = K_means.getDataRanges(dataExtremes);
            means = K_means.initMeans(6, dataExtremes, dataRange);
            K_means.makeAssignments(P);
            K_means.run(P);

            console.log(means);
            console.log(assignments);

            //======================k-means=========================================

            var classficy = [];
            for (var j = 0; j < 12; j++) {
                var temp = [];
                for (var i = 0; i < posts.length; i++) {
                    var month = posts[i].created_time.getMonth();
                    if (month == j) {
                        temp.push({
                            "post": posts[i],
                            "index": i
                        });
                    }
                }
                classficy[j] = temp;
            }

            //console.log(classficy);

            var window_height = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
            var window_width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;


            //================y軸 以原點到個貼文之間的距離================================
            var origin = [];
            for (var i = 0; i < posts.length; i++) {
                var dis = Math.pow(Positions[0][i], 2) + Math.pow(Positions[1][i], 2);
                dis = Math.sqrt(dis);

                origin.push(Positions[0][i]);
            }
            //========================================================================



            var graph = d3.select("#main");

            var svg = graph.append("svg")
                .attr("x", 0)
                .attr("y", 0)
                .attr("height", 250)
                .attr("width", 250)
                .attr("id", "svg1");

            var h = 250,
                w = 250;



            var rect = svg.append("rect")
                .attr("x", 0)
                .attr("y", 0)
                .attr("height", h)
                .attr("width", w)
                .attr("fill", "white");


            xScale = d3.scaleLinear()
                .range([25, 225])
                .domain([Math.min.apply(null, Positions[0]), Math.max.apply(null, Positions[0])]);
            yScale = d3.scaleLinear()
                .range([25, 225])
                .domain([Math.max.apply(null, Positions[1]), Math.min.apply(null, Positions[1])]);
            color = d3.scaleLinear()
                .domain([0, classficy.length])
                .interpolate(d3.interpolateHcl)
                .range([d3.rgb("#007AFF"), d3.rgb('#FFF500')])



            var circle = svg.selectAll("circle")
                .data(posts)
                .enter()
                .append("circle")
                .attr("id", function (d, i) {
                    return i;
                })
                .attr("cx", function (d, i) {
                    return xScale(Positions[0][i]);
                })
                .attr("cy", function (d, i) {
                    return yScale(Positions[1][i]);
                })
                .attr("r", 2.5)
                .attr("fill", function (d, i) {
                    return color(assignments[i]);
                });
            //==========================brush============================
            var brush = d3.brush()
                .extent([
                    [0, 0],
                    [w, h]
                ])
                .on("end", brushmoved);

            svg.append("g")
                .attr("class", "brush")
                .call(brush);
            var selecttemp = [];
            //===========================================================

            d3.select("#main")
                .append("svg")
                .style('position', 'absolute')
                .style("left", 300 + "px")
                .attr("width", window_width - 300)
                .attr("height", window_height / 2)
                .attr("id", "svg2");

            xScale
                .domain([Math.min.apply(null, Positions[0]), Math.max.apply(null, Positions[0])]);
            yScale
                .domain([Math.max.apply(null, Positions[1]), Math.min.apply(null, Positions[1])]);

            var pagging = 10;

            var pos = multiplot.multi(pagging, classficy, window_width - 300, window_height / 2);

            multiplot.plot(pos, classficy, Positions);

            d3.select("#main")
                .append("svg")
                .style('position', 'absolute')
                .style("top", window_height / 2 + "px")
                .style("left", 0 + "px")
                .attr("width", window_width)
                .attr("height", window_height / 2)
                .attr("id", "svg3");

            function brushmoved() {

                selecttemp = [];
                var s = d3.event.selection;
                console.log(s);
                var circle = d3.select("#svg1").selectAll("circle")._groups[0];
                //console.log(circle);

                for (var i = 0; i < circle.length; i++) {

                    if (circle[i].attributes.cx.value >= s[0][0] && circle[i].attributes.cx.value <= s[1][0]) {

                        if (circle[i].attributes.cy.value >= s[0][1] && circle[i].attributes.cy.value <= s[1][1]) {
                            //console.log("push");
                            selecttemp.push(circle[i]);
                        }

                    }

                }
                console.log(selecttemp);

                d3.selectAll("#subbrush").remove();

                var y = d3.scaleLinear()
                    .range([0, 150])
                    .domain([0, 250]);

                for (var i = 0; i < pos.length; i++) {

                    d3.select("#svg2")
                        .append("rect")
                        .attr("id", "subbrush")
                        .attr("x", y(s[0][0]) + pos[i].x)
                        .attr("y", y(s[0][1]) + pos[i].y)
                        .attr("height", y(s[1][1] - s[0][1]))
                        .attr("width", y(s[1][0] - s[0][0]))
                        .attr("fill", "gray")
                        .style("opacity", 0.3);

                }

            }

        }

        //===============get data=================================
        function retrievePostid() {
            function reqListener() {
                var raw_data = JSON.parse(this.responseText);
                //console.log(raw_data);
                /*
                for(var i = 0; i < 20; i++){
                    raw_data.push(raw_data[i]);
                }
                */
                main(raw_data);
                //data = raw_data;
                //temp = [];
            }
            //console.log(since);
            var oReq = new XMLHttpRequest();
            oReq.onload = reqListener;

            var qurl = "compare" + "?action=start";
            console.log(qurl);
            oReq.open("get", qurl, true);
            oReq.send();
        }
        window.onload = retrievePostid;
    </script>
</body>

</html>