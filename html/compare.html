<!DOCTYPE html>
<meta charset="utf-8">
<html>

<!--lib-->
<script src="http://d3js.org/d3.v4.min.js"></script>
<script src="http://numericjs.com/numeric/lib/numeric-1.2.6.min.js"></script>
<link rel="stylesheet" href="../src/style.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>



<!--srcs-->
<link rel="stylesheet" href="../src/style.css">
<script src="../src/K-means.js"></script>
<script src="../src/mds.js"></script>
<script src="../src/sylvester.src.js"></script>
<script src="../src/dissimilar.js"></script>
<script src="../src/multiplot.js"></script>
<script src="../src/tsne.js"></script>
<script src="../src/d3cloud.js"></script>

<body class="blue">
    <div id="main"></div>

    <div id="tooltip" class="hidden">
        <p><strong><span id="month"></span></strong></p>
        <p>Toatl <span id="value"></span></p>
        <p>Avg like : <span id="like"></span></p>
        <p>Avg share : <span id="share"></span></p>
        <p>Avg comment : <span id="comment"></span></p>
    </div>

    <div id="tooltip2" class="hidden">
        <p><span id="message"></span></p>
        <p>Time : <span id="time"></span></p>
        <p>Like : <span id="like"></span></p>
        <p>Share : <span id="share"></span></p>
        <p>Comment : <span id="comment"></span></p>
    </div>

    <script>
        var posts = [];
        var xScale, yScale, color;
        var select_rect = [],
            select = [];
        var means = [];
        var assignments = [];
        var dataExtremes;
        var dataRange;
        var feature = "like";

        function main(data) {
            //console.log(data);
            for (var i = 0; i < data.length; i++) {
                posts[i] = {
                    "post": i,
                    "id": data[i].id,
                    "from": data[i].from,
                    "type": data[i].type,
                    "created_time": new Date(data[i].created_time),
                    "like": data[i].reactions.like + data[i].reactions.love + data[i].reactions.haha + data[i].reactions
                        .wow + data[i].reactions.sad + data[i].reactions.angry,
                    "reactions": data[i].reactions,
                    "share": data[i].shares,
                    "comment": data[i].comments.summary,
                    "message": data[i].message,
                    "log_like": Math.log(data[i].likes + 1) / Math.log(10),
                    "log_share": Math.log(data[i].shares + 1) / Math.log(10),
                    "log_comment": Math.log(data[i].comments.summary + 1),
                    "message_length": Math.log(data[i].message_length + 1),
                    "word": data[i].word,
                    "comment_context": data[i].comments.context
                };
            }

            posts.sort(function (a, b) {
                return new Date(a.created_time) - new Date(b.created_time);
            });

            console.log(posts);

            var dis_distance = dissimilar.distance(posts, null);
            console.log(dis_distance);
            var P = mds.classic(dis_distance);
            //var Positions = numeric.transpose(P);

            //==============================normalize====================================================
            /*
                        var max = 0;
                        for (var i = 0; i < dis_distance.length; i++) {
                            if (Math.max.apply(null, dis_distance[i]) >= max) {
                                max = Math.max.apply(null, dis_distance[i]);
                            }
                        }

                        console.log("Max dis: " + max);

                        for (var i = 0; i < dis_distance.length; i++) {
                            for (var j = 0; j < dis_distance.length; j++) {
                                dis_distance[i][j] = 1 - (dis_distance[i][j] / max);
                            }
                        }
            */
            //==============================normalize====================================================

            //==========================t-sne==========================================================
            var opt = {}
            opt.epsilon = 10; // epsilon is learning rate (10 = default)
            opt.perplexity = 15; // roughly how many neighbors each point influences (30 = default)
            opt.dim = 2; // dimensionality of the embedding (2 = default)

            var tsne = new tsnejs.tSNE(opt); // create a tSNE instance

            tsne.initDataDist(dis_distance, P);


            for (var k = 0; k < 1000; k++) {
                tsne.step(); // every time you call this, solution gets better
            }

            var P = tsne.getSolution(); // Y is an array of 2-D points that you can plot
            //==========================t-sne==========================================================

            console.log(numeric.transpose(P));

            //var P = mds.classic(dis_distance);
            var Positions = numeric.transpose(P);

            //======================k-means=========================================

            dataExtremes = K_means.getDataExtremes(P);
            dataRange = K_means.getDataRanges(dataExtremes);
            means = K_means.initMeans(8, dataExtremes, dataRange);
            K_means.makeAssignments(P);
            K_means.run(P);

            console.log(means);
            console.log(assignments);

            //======================k-means=========================================

            var classficy = [];
            for (var j = 0; j < 12; j++) {
                var temp = [];
                for (var i = 0; i < posts.length; i++) {
                    var month = posts[i].created_time.getMonth();
                    if (month == j) {
                        temp.push({
                            "post": posts[i],
                            "index": i
                        });
                    }
                }
                classficy[j] = temp;
            }

            //console.log(classficy);

            var window_height = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
            var window_width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;


            //================y軸 以原點到個貼文之間的距離================================
            var origin = [];
            for (var i = 0; i < posts.length; i++) {
                var dis = Math.pow(Positions[0][i], 2) + Math.pow(Positions[1][i], 2);
                dis = Math.sqrt(dis);

                origin.push(Positions[0][i]);
            }
            //========================================================================



            var graph = d3.select("#main");

            var svg = graph.append("svg")
                .attr("x", 0)
                .attr("y", 0)
                .attr("height", 250)
                .attr("width", 250)
                .attr("id", "svg1");

            var color_scale = d3.scaleLinear().domain([0, 5]).range(['beige', 'red']);

            //======================four button=======================================
            graph.append("input")
                .attr("type", "button")
                .attr("class", "btn btn-primary btn-xs")
                .attr("value", "Like")
                .style("position", "absolute")
                .style("top", "260px")
                .style("left", "5px")
                .on("click", function () {
                    feature = "like";

                    d3.select("#svg1")
                        .selectAll("circle")
                        .attr("fill", function (d) {
                            return color_scale(d.log_like);
                        })
                });

            graph.append("input")
                .attr("type", "button")
                .attr("class", "btn btn-primary btn-xs")
                .attr("value", "Comment")
                .style("position", "absolute")
                .style("top", "260px")
                .style("left", "50px")
                .on("click", function () {
                    feature = "comment";

                    d3.select("#svg1")
                        .selectAll("circle")
                        .attr("fill", function (d) {
                            return color_scale(d.log_comment);
                        })
                });

            graph.append("input")
                .attr("type", "button")
                .attr("class", "btn btn-primary btn-xs")
                .attr("value", "Share")
                .style("position", "absolute")
                .style("top", "260px")
                .style("left", "125px")
                .on("click", function () {
                    feature = "share";

                    d3.select("#svg1")
                        .selectAll("circle")
                        .attr("fill", function (d) {
                            return color_scale(d.log_share);
                        })
                });

            graph.append("input")
                .attr("type", "button")
                .attr("class", "btn btn-primary btn-xs")
                .attr("value", "Message length")
                .style("position", "absolute")
                .style("top", "260px")
                .style("left", "175px")
                .on("click", function () {
                    feature = "message";

                    d3.select("#svg1")
                        .selectAll("circle")
                        .attr("fill", function (d) {
                            return color_scale(d.message_length);
                        })
                });

            //======================three button======================================


            var h = 250,
                w = 250;



            var rect = svg.append("rect")
                .attr("x", 0)
                .attr("y", 0)
                .attr("height", h)
                .attr("width", w)
                .attr("fill", "white");


            xScale = d3.scaleLinear()
                .range([25, 225])
                .domain([Math.min.apply(null, Positions[0]), Math.max.apply(null, Positions[0])]);
            yScale = d3.scaleLinear()
                .range([25, 225])
                .domain([Math.max.apply(null, Positions[1]), Math.min.apply(null, Positions[1])]);
            color = d3.scaleOrdinal(d3.schemeCategory10);



            var circle = svg.selectAll("circle")
                .data(posts)
                .enter()
                .append("circle")
                .attr("id", function (d, i) {
                    return i;
                })
                .attr("cx", function (d, i) {
                    return xScale(Positions[0][i]);
                })
                .attr("cy", function (d, i) {
                    return yScale(Positions[1][i]);
                })
                .attr("r", 2.5)
                .attr("fill", function (d, i) {
                    return color(assignments[i]);
                });
            //==========================brush============================
            var brush = d3.brush()
                .extent([
                    [0, 0],
                    [w, h]
                ])
                .on("end", brushmoved);

            svg.append("g")
                .attr("class", "brush")
                .call(brush);
            var selecttemp = [];
            //===========================================================

            d3.select("#main")
                .append("svg")
                .style('position', 'absolute')
                .style("left", 300 + "px")
                .attr("width", window_width - 300)
                .attr("height", window_height / 2)
                .attr("id", "svg2");

            xScale
                .domain([Math.min.apply(null, Positions[0]), Math.max.apply(null, Positions[0])]);
            yScale
                .domain([Math.max.apply(null, Positions[1]), Math.min.apply(null, Positions[1])]);

            var pagging = 10;

            var pos = multiplot.multi(pagging, classficy, window_width - 300, window_height / 2);

            multiplot.plot(pos, classficy, Positions);

            var svg3 = d3.select("#main")
                .append("svg")
                .style('position', 'absolute')
                .style("top", window_height / 2 + "px")
                .style("left", 0 + "px")
                .attr("width", window_width)
                .attr("height", window_height / 2)
                .attr("id", "svg3");

            svg3.append("rect")
                .attr("x", 300)
                .attr("y", 0)
                .attr("id", "mix1")
                .attr("width", (window_height / 2) * 9 / 10)
                .attr("height", (window_height / 2) * 9 / 10)
                .attr("fill", "white");


            svg3.append("rect")
                .attr("x", 650)
                .attr("y", 0)
                .attr("id", "mix2")
                .attr("width", (window_height ) * 8 / 10)
                .attr("height", (window_height / 2) * 9 / 10)
                .attr("fill", "white");

            function brushmoved() {

                selecttemp = [];
                var s = d3.event.selection;
                console.log(s);
                var circle = d3.select("#svg1").selectAll("circle")._groups[0];
                //console.log(circle);

                for (var i = 0; i < circle.length; i++) {

                    if (circle[i].attributes.cx.value >= s[0][0] && circle[i].attributes.cx.value <= s[1][0]) {

                        if (circle[i].attributes.cy.value >= s[0][1] && circle[i].attributes.cy.value <= s[1][1]) {
                            //console.log("push");
                            selecttemp.push(circle[i]);
                        }

                    }

                }
                //console.log(selecttemp);

                multiplot.highlight(selecttemp);

            }

        }

        //===============get data=================================
        function retrievePostid() {
            function reqListener() {
                var raw_data = JSON.parse(this.responseText);
                //console.log(raw_data);
                /*
                for(var i = 0; i < 20; i++){
                    raw_data.push(raw_data[i]);
                }
                */
                main(raw_data);
                //data = raw_data;
                //temp = [];
            }
            //console.log(since);
            var oReq = new XMLHttpRequest();
            oReq.onload = reqListener;

            var qurl = "compare" + "?action=start";
            console.log(qurl);
            oReq.open("get", qurl, true);
            oReq.send();
        }
        window.onload = retrievePostid;
    </script>
</body>

</html>