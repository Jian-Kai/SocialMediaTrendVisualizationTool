<html>

<style>
    
    .links line {
        stroke: #999;
        stroke-opacity: 0.6;
    }

    .links line:hover {
        stroke: red;
    }

    .curve line {
        stroke: orangered;
        stroke-opacity: 0.6;
    }

    .nodes circle {
        stroke: black;
        stroke-width: 1.5px;
    }

    .line {
        fill: none;
        stroke: steelblue;
        stroke-width: 2px;
    }

    .overlay {
        fill: none;
        pointer-events: all;
    }

    .focus circle {
        fill: none;
        stroke: steelblue;
    }

    #tooltip {
        position: absolute;
        padding: 10px;
        background-color: white;
        -webkit-border-radius: 10px;
        -moz-border-radius: 10px;
        border-radius: 10px;
        -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
        overflow-x: hidden;
    }

    #tooltip.hidden {
        display: none;
    }

    #tooltip p {
        margin: 0;
        font-family: sans-serif;
        font-size: 16px;
        line-height: 20px;
    }
</style>

<head>
    <script src="http://d3js.org/d3.v4.min.js"></script>
    <script src="../src/d3.layout.cloud.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>

</head>

<body>

    <div id="main"></div>
    <div id="tooltip" class="hidden">
        <p id="word"></p>
    </div>

</body>

<script>
    d3.json("../data/aug_filter.json", function (json) {
        draw(json);
    })


    function draw(json) {
        var linkset = json.link;
        var bool = 0;

        d3.json("../data/aug_post.json", function (posts) {

            //=====================curve=====================
            let curve_data = [];
            for (var i = 0; i < posts.data.length - 1; i++) {
                curve_data.push({
                    "source": i,
                    "target": i + 1
                })
            }
            //=====================curve=====================

            //===============================================

            let timestack = new Array(31).fill(0);;
            for (var i = 0; i < posts.data.length; i++) {
                var index = new Date(posts.data[i].created_time).getDate() - 1;
                timestack[index] += posts.data[i].comments;
            }

            console.log(timestack);

            var bisectDate = d3.bisector(function(d, i) { return d; }).left

            var x = d3.scaleLinear().range([0, 500]).domain([1, timestack.length]);
            var y = d3.scaleLinear().range([50, 0]).domain([d3.min(timestack), d3.max(timestack)]);

            var valueline = d3.line()
                .x(function (d, i) {
                    return x(i + 1);
                })
                .y(function (d) {
                    return y(d);
                });

            //===============================================


            //console.log(posts);

            var window_height = window.innerHeight || document.documentElement.clientHeight || document.body
                .clientHeight;
            var window_width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;

            window_height -= 100;

            var simulation = d3.forceSimulation()
                .force("link", d3.forceLink().id(function (d, i) {
                    return i;
                }).distance(function (d, i) {
                    if (d.keyword) {
                        return d.keyword.length;
                    } else {
                        var time = new Date(d.created_time).getDate() - new Date(posts.data[i].created_time)
                            .getDate();
                        if (time == 0) {
                            return 1
                        } else
                            return 10;
                    }
                }).strength(0.1))
                .force("charge", d3.forceManyBody())
                .force("center", d3.forceCenter(window_width / 2, window_height / 2))
                .force("collide", d3.forceCollide(function(d){
                    return 5;
                }).iterations(16))
                .force("y", d3.forceY().strength(0.05))
                .force("x", d3.forceX().strength(0.05));

            var color = d3.scaleOrdinal(d3.schemeCategory10);

            var button = d3.select("#main")
                .append("input")
                .attr("type", "button")
                .attr("class", "btn btn-primary btn-xs")
                .attr("value", "switch")
                .on("click", function () {
                    if (bool == 0) {
                        simulation.restart();

                        simulation.nodes(posts.data)
                            .on("tick", function () {

                                time_curve.attr("x1", function (d, i) {
                                        return posts.data[i].x;
                                    })
                                    .attr("y1", function (d, i) {
                                        return posts.data[i].y;
                                    })
                                    .attr("x2", function (d, i) {
                                        return posts.data[i + 1].x;
                                    })
                                    .attr("y2", function (d, i) {
                                        return posts.data[i + 1].y;
                                    });


                                circle.attr("cx", function (d) {
                                    return d.x;
                                }).attr("cy", function (d) {
                                    return d.y;
                                });

                            })
                        simulation.force("link")
                            .links(curve_data);


                        iteration();
                        //simulation.alpha(0.5);

                        //simulation.restart();


                        d3.select("#timecurve").style("visibility", "visible");
                        d3.select("#linkset").style("visibility", "hidden");
                        bool = 1;
                    } else {
                        simulation.restart();

                        simulation.nodes(posts.data)
                            .on("tick", function () {

                                link.attr("x1", function (d) {
                                        return d.source.x;
                                    })
                                    .attr("y1", function (d) {
                                        return d.source.y;
                                    })
                                    .attr("x2", function (d) {
                                        return d.target.x;
                                    })
                                    .attr("y2", function (d) {
                                        return d.target.y;
                                    });


                                circle.attr("cx", function (d) {
                                    return d.x;
                                }).attr("cy", function (d) {
                                    return d.y;
                                });

                            })
                        simulation.force("link")
                            .links(linkset);

                        iteration();
                        //simulation.alpha(0.5);

                        //simulation.restart();

                        d3.select("#timecurve").style("visibility", "hidden");
                        d3.select("#linkset").style("visibility", "visible");
                        bool = 0;
                    }
                });


            var svg = d3.select("#main")
                .append("svg")
                .attr("height", window_height)
                .attr("width", window_width)
                .attr("transform", "translate(" + 0 + "," + 50 + ")");


            svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(250," + 550 + ")")
                .call(d3.axisBottom(x).ticks(timestack.length));

            svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(245," + 500 + ")")
                .call(d3.axisLeft(y).ticks(4));

            svg.append("g")
                .attr("transform", "translate(250," + 500 + ")")
                .append("path")
                .data([timestack])
                .attr("class", "line")
                .attr("d", valueline);

            var focus = svg.append("g")
                .attr("transform", "translate(250," + 500 + ")")
                .attr("class", "focus")
                .style("display", "none");

            focus.append("circle")
                .attr("r", 4.5);

            focus.append("text")
                .attr("x", 9)
                .attr("y", 9)
                .attr("transform", "translate(250," + 500 + ")");

            svg.append("rect")
                .attr("class", "overlay")
                .attr("transform", "translate(250," + 500 + ")")
                .attr("width", 500)
                .attr("height", 50)
                .attr("fill", "gray")
                .on("mouseover", function () {
                    focus.style("display", null);
                })
                .on("mouseout", function () {
                    focus.style("display", "none");
                    d3.select("#posts").selectAll("cirle").attr("steelblue");
                })
                .on("mousemove", mousemove);

            function mousemove() {
                var x0 = Math.round(x.invert(d3.mouse(this)[0]));
                
                focus.attr("transform", "translate(" + (x(x0) + 250) + "," + (y(timestack[x0 - 1]) + 500) + ")");
                focus.select("text").text((posts[x0 - 1]));
                for(var i = 0 ; i < posts.data.length; i++){
                    if(new Date(posts.data[i].created_time).getDate() == x0){
                        d3.select("#post" + i).attr("fill", "yellow");
                    }
                    else{
                        d3.select("#post" + i).attr("fill", "steelblue");
                    }
                }
            }





            var time_curve = svg.append("g")
                .attr("id", "timecurve")
                .attr("class", "curve")
                .style("visibility", "hidden")
                .selectAll("#Time")
                .data(curve_data)
                .enter()
                .append("line")
                .attr("id", "link")
                .attr("stroke-width", function (d) {
                    return 2;
                });


            var link = svg.append("g")
                .attr("id", "linkset")
                .attr("class", "links")
                .style("visibility", "visible")
                .selectAll("#link")
                .data(linkset)
                .enter()
                .append("line")
                .attr("id", "link")
                .attr("stroke-width", function (d) {
                    return d.keyword.length * 2;
                })
                .on("mouseover", function (d) {
                    var xPosition = (d.source.x + d.target.x) / 2;
                    var yPosition = (d.source.y + d.target.y) / 2 - 50;

                    var tooltip = d3.select("#tooltip")
                        .style("left", xPosition + "px")
                        .style("top", yPosition + "px");

                    tooltip.select("#word")
                        .text(d.keyword);

                    tooltip.classed("hidden", false);

                })
                .on("mouseout", function () {
                    d3.select("#tooltip").classed("hidden", true);
                });;


            var circle = svg.append("g")
            .attr("id", "posts")
                .attr("class", "nodes")
                .selectAll("circle")
                .data(posts.data)
                .enter()
                .append("circle")
                .attr("id", function (d, i) {
                    return "post" + i;
                })
                .attr("r", function(d){
                    return 5
                })
                .attr("fill", function (d, i) {
                    if (i == 0) {
                        return "red";
                    }
                    return color(new Date(d.created_time).getMonth());
                })
                .on("mouseover", function (d) {
                    var xPosition = (d.x);
                    var yPosition = (d.y);

                    var tooltip = d3.select("#tooltip")
                        .style("left", xPosition + "px")
                        .style("top", yPosition + "px");

                    tooltip.select("#word")
                        .text(d.created_time);

                    tooltip.classed("hidden", false);

                })
                .on("mouseout", function () {
                    d3.select("#tooltip").classed("hidden", true);
                })
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));


            simulation.nodes(posts.data)
                .on("tick", function () {

                    link.attr("x1", function (d) {
                            return d.source.x;
                        })
                        .attr("y1", function (d) {
                            return d.source.y;
                        })
                        .attr("x2", function (d) {
                            return d.target.x;
                        })
                        .attr("y2", function (d) {
                            return d.target.y;
                        });

                    circle.attr("cx", function (d) {
                        return d.x;
                    }).attr("cy", function (d) {
                        return d.y;
                    });

                })

            simulation.force("link")
                .links(linkset);




            function dragstarted(d) {
                if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(d) {
                d.fx = d3.event.x;
                d.fy = d3.event.y;
            }

            function dragended(d) {
                if (!d3.event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            function iteration() {
                simulation.alphaTarget(0.5);
                setTimeout(function () {
                    simulation.stop();
                }, 5000)
            }

        });
    }
</script>

</html>