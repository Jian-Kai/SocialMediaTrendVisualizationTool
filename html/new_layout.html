<!DOCTYPE html>
<html>

<body>
    <div class="wrapper">
        <div id="timeblocks" class="box timeblocks">
            <svg></svg>
        </div>
        <div id="overview" class="box overview">
            <svg></svg>
        </div>
        <div id="detial" class="box detial">
            <svg></svg>
        </div>
        <div id="compare" class="box compare">
            <svg></svg>
        </div>
    </div>
</body>
<!--lib-->
<script src="http://d3js.org/d3.v4.min.js"></script>
<script src="http://numericjs.com/numeric/lib/numeric-1.2.6.min.js"></script>
<link rel="stylesheet" href="../new_src/style.css">

<!--src-->
<script src="../new_src/overview.js"></script>
<script src="../new_src/mds.js"></script>
<script src="../new_src/tsne.js"></script>
<script src="../new_src/time_block.js"></script>



<script>
    let posts = [],
        block_posts = [];
    let timeblock_svg, overview_svg, compare_svg, detial_svg;
    let position;
    let Xscale, Yscale;

    function main(data) {
        data.sort(function (a, b) {
            return new Date(a.created_time) - new Date(b.created_time);
        });

        for (var i = 0; i < 12; i++) {
            block_posts[i] = [];
        }
        for (var i = 0; i < data.length; i++) {
            posts[i] = {
                "post": i,
                "id": data[i].id,
                "from": data[i].from,
                "type": data[i].type,
                "created_time": new Date(data[i].created_time),
                "like": data[i].reactions.like + data[i].reactions.love + data[i].reactions.haha + data[i].reactions
                    .wow + data[i].reactions.sad + data[i].reactions.angry,
                "reactions": data[i].reactions,
                "share": data[i].shares,
                "comment": data[i].comments.summary,
                "message": data[i].message,
                "log_like": Math.log(data[i].likes + 1) / Math.log(10),
                "log_share": Math.log(data[i].shares + 1) / Math.log(10),
                "log_comment": Math.log(data[i].comments.summary + 1),
                "message_length": Math.log(data[i].message_length + 1),
                "word": data[i].word,
                "comment_context": data[i].comments.context,
                "total_reply": 0
            }
            for (var j = 0; j < data[i].comments.context.length; j++) {
                posts[i].total_reply += data[i].comments.context[j].comment_count;
            }
            posts[i].total_reply = Math.log(posts[i].total_reply + 1);
            block_posts[posts[i].created_time.getMonth()].push(posts[i]);
        }

        console.log(posts);




        timeblock_svg = d3.select('#timeblocks').select("svg").attr("height", "100%").attr("width", "100%");
        overview_svg = d3.select('#overview').select("svg").attr("height", "100%").attr("width", "100%");
        compare_svg = d3.select('#compare').select("svg").attr("height", "100%").attr("width", "100%");
        detial_svg = d3.select('#detial').select("svg").attr("height", "100%").attr("width", "100%");

        function zoomed() {
            var transform = d3.event.transform;
            
            overview_svg.selectAll("circle").attr("transform", function (d, i) {
                return "translate(" + transform.applyX(Xscale(position[0][i])) + "," + transform.applyY(Yscale(position[1][i])) + ")";
            });
            
        }

        var time_position = timeblock.multi();
        timeblock.block(time_position, block_posts);
        position = overview.distance(posts);

        //var time_curve = overview.timeline();
        overview.rander(position);

        console.log("done");


    }
    //===============get data=================================
    function retrievePostid() {
        function reqListener() {
            var raw_data = JSON.parse(this.responseText);
            //console.log(raw_data);
            /*
            for(var i = 0; i < 20; i++){
                raw_data.push(raw_data[i]);
            }
            */
            main(raw_data);
            //data = raw_data;
            //temp = [];
        }
        //console.log(since);
        var oReq = new XMLHttpRequest();
        oReq.onload = reqListener;

        var qurl = "compare" + "?action=start";
        console.log(qurl);
        oReq.open("get", qurl, true);
        oReq.send();
    }
    window.onload = retrievePostid;
</script>

</html>