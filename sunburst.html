<!DOCTYPE html>
<meta charset="utf-8">
<style>
    body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        margin: auto;
        position: relative;
        width: 960px;
    }

    form {
        position: absolute;
        right: 10px;
        top: 10px;
    }

    #explanation {
        position: absolute;
        top: 260px;
        left: 305px;
        width: 140px;
        text-align: center;
        color: #666;
        z-index: -1;
    }

    #percentage {
        font-size: 2.5em;
    }
</style>
<script src="http://d3js.org/d3.v3.min.js"></script>

<form>
  <div id="explanation" style="visibility: hidden;">
         <span id="percentage"></span><br/>
         of visits begin with this sequence of pages
       </div>
</form>

<script>
    var fanpageid = [136845026417486, 232716627404]; //柯P花媽
    var data = [],
        predata = null;
    var oReq = new XMLHttpRequest();
    //oReq.onload = reqListener;
    oReq.onload = function() {
            predata = JSON.parse(this.responseText);
            for (var i = 0; i < predata.data.length; i++) {
                data.push(predata.data[i]);
            }
        }
        //var qurl = "./test.json";
    var qurl = ["./data/posts_2016-07-01_2016-07-31_136845026417486_8-11-(14)-2016.json", "./data/posts_2016-07-01_2016-07-31_232716627404_9-5-(10)-2016.json"];
    //var qurl = "./data/posts_2016-07-01_2016-07-31_232716627404_9-5-(10)-2016.json";
    for (var i = 0; i < qurl.length; i++) {
        console.log(qurl[i]);
        oReq.open("get", qurl[i], false);
        oReq.send();
    }

    var totalSize = 0;

    console.log(data);

    function buildHierarchy(data) {
        var root = {
            "name": "root",
            "children": []
        };
        for (var i = 0; i < fanpageid.length; i++) {
            var children = {
                "name": fanpageid[i],
                "children": []
            };
            root.children.push(children);
        }
        var curroot = root.children;
        for (var i = 0; i < data.length; i++) {
            var children = {
                "name": data[i].id,
                "size": data[i].comments.summary.total_count
            };
            var id = data[i].from.id;
            //==================================================================
            if (curroot[0].name == id) {
                curroot[0].children.push(children);
            } else
                curroot[1].children.push(children);
        }
        //====================================================================
        console.log(root);
        return root;
    }

    var root = buildHierarchy(data);


    var width = 960,
        height = 700,
        radius = Math.min(width, height - 50) / 2,
        color = d3.scale.category20c();

    var svg = d3.select("body").append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

    var partition = d3.layout.partition()
        .sort(null)
        .size([2 * Math.PI, radius * radius])
        .value(function(d) {
            return d.size;
        });

    var arc = d3.svg.arc()
        .startAngle(function(d) {
            return d.x;
        })
        .endAngle(function(d) {
            return d.x + d.dx;
        })
        .innerRadius(function(d) {
            return Math.sqrt(d.y);
        })
        .outerRadius(function(d) {
            return Math.sqrt(d.y + d.dy);
        });



    var path = svg.datum(root).selectAll("path")
        .data(partition.nodes)
        .enter().append("path")
        .attr("display", function(d) {
            return d.depth ? null : "none";
        }) // hide inner ring
        .attr("d", arc)
        .style("stroke", "#fff")
        .style("fill", function(d) {
            return color((d.children ? d : d.parent).name);
        })
        .style("fill-rule", "evenodd")
        .each(stash)
        .on("mouseover", mouseover);

        totalSize = path.node().__data__.value;

    // Stash the old values for transition.
    function stash(d) {
        d.x0 = d.x;
        d.dx0 = d.dx;
    }
    // Fade all but the current sequence, and show it in the breadcrumb trail.
    function mouseover(d) {

        var percentage = (100 * d.value / totalSize).toPrecision(3);
        var percentageString = percentage + "%";
        if (percentage < 0.1) {
            percentageString = "< 0.1%";
        }

        d3.select("#percentage")
            .text(percentageString);

        d3.select("#explanation")
            .style("visibility", "");

    }

    d3.select(self.frameElement).style("height", height + "px");
</script>
